name: Terraform Gitaction

'on':
  push:
    branches:
      - test
  pull_request: null

jobs:
  terraform:
    name: Terraform Setup
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./setup
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v1

  terraform_init:
    name: Terraform Init
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./setup
    needs: terraform 
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Terraform Init
        run: terraform init
        env:
          GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'

  terraform_plan:
    name: Terraform Plan
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./setup
    needs: terraform_init
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color
        env:
          GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'

  terraform_plan_validate:
    name: Terraform Plan validate
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./setup
    needs: terraform_plan
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Terraform Plan validate
        id: validate
        run: terraform validate -no-color
        env:
          GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'

  terraform_pull_request:
    name: Terraform Plan show
    runs-on: ubuntu-latest
    defaults:
      run:
        shell: bash
        working-directory: ./setup
    needs: terraform_plan_validate
    steps:
      - name: Checkout
        uses: actions/checkout@master
      - name: Terraform Plan show
        id: show
        run: terraform show -json -no-color
        env:
          GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'
     
  # terraform_apply:
  #   name: Terraform Apply
  #   runs-on: ubuntu-latest
  #   defaults:
  #     run:
  #       shell: bash
  #       working-directory: ./setup
  #   needs: terraform
  #   steps:
  #     - name: Checkout
  #       uses: actions/checkout@master
  #     - name: Terraform Init
  #       run: terraform init
  #       env:
  #         GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'
  #     - name: Terraform Apply
  #       if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
  #       run: terraform apply -auto-approve
  #       env:
  #         GOOGLE_CREDENTIALS: '${{ secrets.GCP_SA_KEY }}'

